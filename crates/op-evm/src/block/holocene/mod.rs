use std::collections::HashMap;

use alloy_op_hardforks::OpHardforks;
use alloy_primitives::{Address, B256, U256};
use reth_chainspec::EthChainSpec;
use revm::{
    database::State,
    state::{Account, Bytecode, EvmStorageSlot},
    Database, DatabaseCommit,
};
use tracing::info;

mod constants;

/// The Holocene hardfork issues an irregular state transition that upgrades the remaining
/// frax tokens to upgreadable proxies.
pub(super) fn migrate_frax_holocene<DB>(
    chain_spec: impl OpHardforks + EthChainSpec,
    timestamp: u64,
    db: &mut State<DB>,
) -> Result<(), DB::Error>
where
    DB: revm::Database,
{
    // If the granite hardfork is active at the current timestamp, and it was not active at the
    // previous block timestamp (heuristically, block time is not perfectly constant at 2s), and the
    // chain is an optimism chain, then we need to upgrade the frax/sfrax contracts.
    if chain_spec.is_holocene_active_at_timestamp(timestamp)
        && !chain_spec.is_holocene_active_at_timestamp(timestamp.saturating_sub(2))
    {
        info!(target: "evm", "Forcing frax upgrades on Holocne transition");

        let (proxy_migrations, bytecode_migrations, storage_migrations) =
            match chain_spec.chain().id() {
                2521 => (Some(constants::TESTNET_TOKENS_ADDRESSES), None, None),
                2522 => (Some(constants::DEVNET_TOKENS_ADDRESSES), None, None),
                _ => (
                    Some(constants::MAINNET_TOKENS_ADDRESSES),
                    Some(constants::MAINNET_NAMING_BYTECODE_CHANGES),
                    Some(constants::MAINNET_NAMING_STORAGE_CHANGES),
                ),
            };

        if let Some(migrations) = proxy_migrations {
            for addr in migrations {
                let mut implementation_addr = addr.clone();
                implementation_addr[0..3].copy_from_slice(&[252, 192, 211]);
                info!(target: "evm", "Setting implementation from {} to {}", addr, implementation_addr);

                let mut current_contract_acc = load_contract_account(db, *addr)?;
                let new_implementation_code = get_contract_code(db, &current_contract_acc);

                let mut implementation_acc = load_contract_account(db, implementation_addr)?;
                implementation_acc.code = Some(Bytecode::new_raw(new_implementation_code.into()));
                implementation_acc.code_hash = implementation_acc
                    .code
                    .as_ref()
                    .unwrap_or(&Bytecode::new())
                    .hash_slow();
                let mut implementation_revm_account: Account = implementation_acc.into();
                implementation_revm_account.mark_touch();

                let proxy_acc: revm::state::AccountInfo =
                    load_contract_account(db, constants::PROXY_ADDR)?;
                current_contract_acc.code = proxy_acc.code.clone();
                current_contract_acc.code_hash = proxy_acc.code_hash.clone();

                let mut current_contract_revm_account: Account = current_contract_acc.into();
                current_contract_revm_account.mark_touch();
                info!(target: "evm", "Setting proxy {} admin to {}", constants::PROXY_ADDR, constants::PROXY_ADMIN_ADDR);
                current_contract_revm_account.storage.insert(
                    U256::from_be_bytes(constants::PROXY_ADMIN_SLOT.into()),
                    EvmStorageSlot::new_changed(
                        U256::default(),
                        U256::from_be_bytes(
                            B256::left_padding_from(constants::PROXY_ADMIN_ADDR.as_slice()).into(),
                        ),
                    ),
                );
                info!(target: "evm", "Setting proxy {} implementation to {}", constants::PROXY_ADDR, implementation_addr);
                current_contract_revm_account.storage.insert(
                    U256::from_be_bytes(constants::PROXY_IMPLEMENTATION_SLOT.into()),
                    EvmStorageSlot::new_changed(
                        U256::default(),
                        U256::from_be_bytes(
                            B256::left_padding_from(implementation_addr.as_slice()).into(),
                        ),
                    ),
                );

                db.commit(HashMap::from_iter([
                    (implementation_addr, implementation_revm_account),
                    (*addr, current_contract_revm_account),
                ]));
            }
        }

        if let Some(migrations) = bytecode_migrations {
            for change in migrations {
                info!(target: "evm", "Doing bytecdoe migration of account {}", change.address);

                let mut acc = load_contract_account(db, change.address)?;
                let mut code = get_contract_code(db, &acc);

                info!(target: "evm", "Original contract code length: {}", code.len());

                code[change.offset..change.offset + change.value.len()]
                    .copy_from_slice(&change.value);

                info!(target: "evm", "New contract code length: {}", code.len());

                acc.code = Some(Bytecode::new_raw(code.into()));
                acc.code_hash = acc.code.as_ref().unwrap_or(&Bytecode::new()).hash_slow();
                let mut revm_acc: Account = acc.into();
                revm_acc.mark_touch();

                db.commit(HashMap::from_iter([(change.address, revm_acc)]));
            }
        }

        if let Some(migrations) = storage_migrations {
            for change in migrations {
                info!(target: "evm", "Doing storage migration of account {}", change.address);

                let mut acc: Account = load_contract_account(db, change.address)?.into();

                acc.storage.insert(
                    change.storage_slot.into(),
                    EvmStorageSlot::new_changed(U256::default(), change.value.into()),
                );

                acc.mark_touch();

                db.commit(HashMap::from_iter([(change.address, acc)]));
            }
        }
    }
    Ok(())
}

fn load_contract_account<DB>(
    db: &mut State<DB>,
    address: Address,
) -> Result<revm::state::AccountInfo, DB::Error>
where
    DB: revm::Database,
{
    Ok(db
        .load_cache_account(address)?
        .account_info()
        .unwrap_or_default())
}

fn get_contract_code<DB>(db: &mut State<DB>, account: &revm::state::AccountInfo) -> Vec<u8>
where
    DB: revm::Database,
{
    account
        .code
        .clone()
        .unwrap_or_else(|| db.code_by_hash(account.code_hash).unwrap_or_default())
        .bytes_slice()
        .to_owned()
}

#[cfg(test)]
mod tests {
    use alloy_primitives::hex::ToHexExt;
    use alloy_primitives::{address, bytes, hex};

    use crate::block::holocene::constants::ByteCodeChange;

    #[test]
    fn test_bytecode_change() {
        let mut code = hex!("0x60003560e01c6005600560068306026153c801601b39600051600760078260ff16848460181c0260181c06028260081c61ffff160160193950600051818160181c14600336111661004f57612a15565b8060fe163610348260011602176153c3578060081c61ffff16565b602061559160403960206040f35b602060043560206155f16000396000518110156153c35760051b6080016155910160403960206040f35b600a5460405260206040f35b600b5460405260206040f35b64012a05f20060405260206040f35b600c5460405260206040f35b600d5460405260206040f35b600e5460405260206040f35b600f5460405260206040f35b6004356010548110156153c3576011015460405260206040f35b60235460405260206040f35b60245460405260206040f35b60255460405260206040f35b6020806040528060400160206020615cd16000396000510180615cd18339508051806020830101601f82600003163682375050601f19601f825160200101169050810190506040f35b6020806040528060400160206020615d316000396000510180615d318339508051806020830101601f82600003163682375050601f19601f825160200101169050810190506040f35b601260405260206040f35b60208060805260066040527f76372e302e30000000000000000000000000000000000000000000000000000060605260408160800181518152602082015160208201528051806020830101601f82600003163682375050601f19601f8251602001011690509050810190506080f35b6004358060a01c6153c357604052602660405160205260005260406000205460605260206060f35b6004358060a01c6153c3576040526024358060a01c6153c3576060526027604051602052600052604060002080606051602052600052604060002090505460805260206080f35b6004358060a01c6153c357604052602960405160205260005260406000205460605260206060f35b6020615db160403960206040f35b3361136052610302565b6084358060a01c6153c357611360525b60043580600f0b81186153c3576113205260243580600f0b81186153c357611340526000546002146153c3576002600055602033610dc05261132051610de05261134051610e005260406044610e203761136051610e60526000610e805261036b6113806145d5565b6113806003600055f35b336113605261038f565b6084358060a01c6153c357611360525b60043580600f0b81186153c3576113205260243580600f0b81186153c357611340526000546002146153c357600260005560206158316000396000516153c357602033610dc05261132051610de05261134051610e005260406044610e203761136051610e60526001610e80526104076113806145d5565b6113806003600055f35b33610a805261042b565b6044358060a01c6153c357610a80525b60043560040160088135116153c357803560208160051b018083610960375050506000546002146153c3576002600055610a8051156153c35761046f610ac0613370565b610ac051610aa052610482610be0613177565b610be0805160208160051b0180610ac0828560045afa505050506104a7610d00612e1e565b610d00805160208160051b0180610be0828560045afa50505050610be05160208160051b01806103c082610be060045afa505050610ac05160208160051b01806104e082610ac060045afa505050610aa05161060052610508610d20614884565b610d2051610d0052602854610d2052610ac05160208160051b0180610d4082610ac060045afa505050600060206155b1600039600051600881116153c35780156105eb57905b80610e6052610e6051610960518110156153c35760051b6109800151156105d657610e6051610d40518110156153c35760051b610d60018051610e6051604052610e6051610960518110156153c35760051b610980015160605233608052600060a0526105bc610e80612a5c565b610e80518082018281106153c357905090508152506105e0565b610d2051156153c3575b60010181811861054e575b5050610be05160208160051b01806103c082610be060045afa505050610d405160208160051b01806104e082610d4060045afa505050610aa05161060052610634610e80614884565b610e8051610e6052610d0051610e605111156153c3576000610e80526000610fa052610d2051156109d757606036610fc0376020615591600039600051610d0051610e60518082018281106153c35790509050046110205260403661104037600160206155916000396000510360021b6020615591600039600051600a54020461108052600060206155b1600039600051600881116153c35780156108dc57905b806110a052610e60516110a051610ac0518110156153c35760051b610ae001518082028115838383041417156153c35790509050610d005180156153c35780820490509050610fc0526000610fe0526110a051610d40518110156153c35760051b610d6001516110005261100051610fc0511161075e57610fc0516110005103610fe05261076c565b61100051610fc05103610fe0525b670de0b6b3a76400006110a051610be0518110156153c35760051b610c0001516110a051610ac0518110156153c35760051b610ae00151611000518082018281106153c357905090508082028115838383041417156153c3579050905004611040526110405160405261102051606052611080516080526107ee6110c0613a1b565b6110c05161106052610e8051600781116153c3576402540be40061106051610fe0518082028115838383041417156153c35790509050048160051b610ea0015260018101610e8052506110a0516010548110156153c35760110180546402540be4006110a051610e80518110156153c35760051b610ea0015164012a05f20081028164012a05f2008204186153c3579050048082018281106153c357905090508155506110a051610d40518110156153c35760051b610d600180516110a051610e80518110156153c35760051b610ea001518082038281116153c357905090508152506001018181186106d5575b5050610be05160208160051b0180604082610be060045afa505050610d405160208160051b018061016082610d4060045afa50505061091c6111c06132b8565b6111c0805160208160051b01806110a0828560045afa505050506110a05160208160051b01806040826110a060045afa505050610aa051610160526109626111c061347b565b6111c051610e6052610d0051610d2051610e6051610d00518082038281116153c357905090508082028115838383041417156153c3579050905004610fa0526110a05160208160051b0180610340826110a060045afa505050610aa05161046052610e605161048052610a5261403956610a52565b610e6051610fa052610e6051604052610e60516060526109f8610fc0612a1b565b610fc051602255602554604052610a10611000613adb565b6110006040610fc060408360045afa505042610fe0511015610a525742610fe052610fc051604052610fe051606052610a4a611000612a1b565b611000516025555b602435610fa0511015610ac5576014610fc0527f536c697070616765207363726577656420796f75000000000000000000000000610fe052610fc050610fc05180610fe001601f826000031636823750506308c379a0610f80526020610fa052601f19601f610fc0510116604401610f9cfd5b610d2051610fa0518082018281106153c35790509050610d20526026610a805160205260005260406000208054610fa0518082018281106153c35790509050815550610d2051602855610a805160007fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef610fa051610fc0526020610fc0a3337f189c623b666b1b45b83d7178f39b8c087cb09774317ca2f53c2d3c3726f222a2608080610fc05280610fc0016000610960518083528060051b600082600881116153c3578015610baf57905b8060051b61098001518160051b602088010152600101818118610b91575b5050820160200191505090508101905080610fe05280610fc0016000610e80518083528060051b600082600881116153c3578015610c0757905b8060051b610ea001518160051b602088010152600101818118610be9575b50508201602001915050905081019050610e605161100052610d205161102052610fc0a26020610fa06003600055f35b33610b0052610c51565b6064358060a01c6153c357610b00525b60243580600f0b81186153c357610ae0526000546002146153c3576002600055600435156153c357606036610b20376000610c80526000610ca0526004356103c052610ae0516103e052610ca6610cc0614bd6565b610cc08051610b20526020810151610b405260408101805160208160051b0180610b60828560045afa50505050610160810151610c8052610180810151610ca05250604435610b20511015610d5b576018610cc0527f4e6f7420656e6f75676820636f696e732072656d6f7665640000000000000000610ce052610cc050610cc05180610ce001601f826000031636823750506308c379a0610c80526020610ca052601f19601f610cc0510116604401610c9cfd5b610ae0516010548110156153c35760110180546402540be400610b405164012a05f20081028164012a05f2008204186153c3579050048082018281106153c3579050905081555033604052600435606052610db46150c6565b610ae051604052610b2051606052610b0051608052610dd1612c34565b337f6f48129db1f37ccb9cc5dd7e119cb32750cabdf75b48375d730d26ce3659bbe1610ae051610cc052600435610ce052610b2051610d0052602854610d20526080610cc0a2610b605160208160051b018061034082610b6060045afa505050610c805161046052610ca05161048052610e49614039565b6020610b206003600055f35b33610a8052610e6f565b6044358060a01c6153c357610a80525b60043560040160088135116153c357803560208160051b018083610960375050506000546002146153c3576002600055610eaa610ac0613370565b610ac051610aa052610ebd610be0612e1e565b610be0805160208160051b0180610ac0828560045afa50505050610ee2610d00613177565b610d00805160208160051b0180610be0828560045afa50505050610ac05160208160051b01806103c082610ac060045afa505050610be05160208160051b01806104e082610be060045afa505050610aa05161060052610f43610d20614884565b610d2051610d0052610be05160208160051b0180610d2082610be060045afa505050600060206155b1600039600051600881116153c357801561101e57905b80610e4052610e4051610960518110156153c35760051b61098001511561101357610e4051610d20518110156153c35760051b610d40018051610e4051610960518110156153c35760051b61098001518082038281116153c35790509050815250610e4051604052610e4051610960518110156153c35760051b6109800151606052610a8051608052611013612c34565b600101818118610f82575b5050610ac05160208160051b01806103c082610ac060045afa505050610d205160208160051b01806104e082610d2060045afa505050610aa05161060052611067610e60614884565b610e6051610e4052600160206155916000396000510360021b6020615591600039600051600a540204610e60526020615591600039600051610d0051610e40518082018281106153c3579050905004610e80526000610ea0526000610fc052608036610fe037600060206155b1600039600051600881116153c35780156112f157905b8061106052610e405161106051610be0518110156153c35760051b610c0001518082028115838383041417156153c35790509050610d005180156153c357808204905090506110005260006110205261106051610d20518110156153c35760051b610d400151611040526110405161100051116111735761100051611040510361102052611181565b611040516110005103611020525b670de0b6b3a764000061106051610ac0518110156153c35760051b610ae0015161106051610be0518110156153c35760051b610c000151611040518082018281106153c357905090508082028115838383041417156153c3579050905004610fe052610fe051604052610e8051606052610e6051608052611203611080613a1b565b61108051610fc052610ea051600781116153c3576402540be400610fc051611020518082028115838383041417156153c35790509050048160051b610ec0015260018101610ea05250611060516010548110156153c35760110180546402540be40061106051610ea0518110156153c35760051b610ec0015164012a05f20081028164012a05f2008204186153c3579050048082018281106153c3579050905081555061106051610d20518110156153c35760051b610d4001805161106051610ea0518110156153c35760051b610ec001518082038281116153c357905090508152506001018181186110ea575b5050610ac05160208160051b01806103c082610ac060045afa505050610d205160208160051b01806104e082610d2060045afa505050610aa0516106005261133a611060614884565b61106051610e4052610ac05160208160051b0180604082610ac060045afa505050610d205160208160051b018061016082610d2060045afa5050506113806110606132b8565b611060805160208160051b0180611180828560045afa50505050610aa0516112a052610e40516112c05261016061034061016061118060045afa506113c3614039565b60285461106052610d0051610d0051610e40518082038281116153c35790509050611060518082028115838383041417156153c3579050905004600181018181106153c357905061108052600261108051106153c35760243561108051111561148c5760146110a0527f536c697070616765207363726577656420796f750000000000000000000000006110c0526110a0506110a051806110c001601f826000031636823750506308c379a061106052602061108052601f19601f6110a051011660440161107cfd5b336040526110805160605261149f6150c6565b337f3631c28b1f9dd213e0319fb167b554d76b6c283a41143eb400a0d1adb1af17556080806110a052806110a0016000610960518083528060051b600082600881116153c357801561150b57905b8060051b61098001518160051b6020880101526001018181186114ed575b50508201602001915050905081019050806110c052806110a0016000610ea0518083528060051b600082600881116153c357801561156357905b8060051b610ec001518160051b602088010152600101818118611545575b50508201602001915050905081019050610e40516110e05261106051611080518082038281116153c35790509050611100526110a0a260206110806003600055f35b336103c05260016103e0526115ee565b6044358060a01c6153c3576103c05260016103e0526115ee565b6044358060a01c6153c3576103c0526064358060011c6153c3576103e0525b60243560040160088135116153c357803560208160051b0180836102a0375050506000546002146153c357600260005560285461040052600435156153c35760206155916000396000516102a051186153c357600061042052611652610660613177565b610660805160208160051b0180610540828560045afa50505050600061066052600060206155b1600039600051600881116153c35780156117c157905b80610680526104005161068051610540518110156153c35760051b61056001516004358082028115838383041417156153c357905090500461066052610680516102a0518110156153c35760051b6102c001516106605110156117775760306106a0527f5769746864726177616c20726573756c74656420696e20666577657220636f696106c0527f6e73207468616e206578706563746564000000000000000000000000000000006106e0526106a0506106a051806106c001601f826000031636823750506308c379a061066052602061068052601f19601f6106a051011660440161067cfd5b61042051600781116153c357610660518160051b610440015260018101610420525061068051604052610660516060526103c0516080526117b6612c34565b60010181811861168f575b5050336040526004356060526117d56150c6565b6025546040526117e66106c0613adb565b6106c0604061068060408360045afa50506022546106c0526fffffffffffffffffffffffffffffffff6106c051166106e0526106e051610400516106e0516004358082028115838383041417156153c35790509050048082038281116153c35790509050610740526106c05161012052602454610140526106a05161016052611870610700613f2e565b610700516107605260406040604061074060045afa50611891610720612a1b565b61072051602255426106a05110156118c957426106a052610680516040526106a0516060526118c1610700612a1b565b610700516025555b337f347ad828e58cbe534d8f6b67985d791360756b18f0d95fd9f197a66cc46480ea6060806107005280610700016000610420518083528060051b600082600881116153c357801561193557905b8060051b61044001518160051b602088010152600101818118611917575b5050820160200191505090508101905080610720528061070001600060008252600060006000600881116153c357801561198257905b60008160051b60208701015260010181811861196b575b505081016020019050905081019050600435610400510361074052610700a26103e051156119b2576119b2615136565b6020806107005280610700016000610420518083528060051b600082600881116153c35780156119fc57905b8060051b61044001518160051b6020880101526001018181186119de575b505082016020019150509050810190506107006003600055f35b6000546002146153c3576002600055611a2d615136565b6003600055005b6fffffffffffffffffffffffffffffffff6004356019548110156153c357601a01541660405260206040f35b6004356019548110156153c357601a015460801c60405260206040f35b611a886103e0613370565b6103e0516103c052611a9b610500612e1e565b610500805160208160051b0180610860828560045afa50505050611ac0610620613177565b610620805160208160051b0180610980828560045afa50505050610240604061024061086060045afa50611af56107406132b8565b610740805160208160051b01806103e0828560045afa505050506103e05160208160051b01806040826103e060045afa5050506103c05161016052611b3b61052061347b565b610520516105005260206103e05160208160051b01806040826103e060045afa5050506103c051610160526105005161018052611b79610520613b00565b61052060043581518110156153c35760051b60208201019050f35b6000546002146153c35760206004356019548110156153c357601a015461012052602354610140526fffffffffffffffffffffffffffffffff6025541661016052611be0610200613f2e565b610200f35b6000546002146153c3576020602254610120526024546101405260255460801c61016052611c14610200613f2e565b610200f35b6004358060a01c6153c35760c0523360405260c051606052602435608052611c3f615343565b600160e052602060e0f35b6004358060a01c6153c35760c0526024358060a01c6153c35760e05260c05160405260e051606052604435608052611c80615343565b602760c051602052600052604060002080336020526000526040600020905054610100527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6101005114611d3f57610100516044358082038281116153c357905090506101205261012051602760c0516020526000526040600020803360205260005260406000209050553360c0517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92561012051610140526020610140a35b6001610120526020610120f35b6004358060a01c6153c3576040526024356027336020526000526040600020806040516020526000526040600020905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560243560605260206060a3600160605260206060f35b6004358060a01c6153c357610120526024358060a01c6153c357610140526084358060081c6153c3576101605261012051156153c35760643542116153c35760296101205160205260005260406000205461018052600060026101c0527f19010000000000000000000000000000000000000000000000000000000000006101e0526101c0805160208201836103200181518152505080830192505050611e606102006152ae565b610200518161032001526020810190507f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c961024052610120516102605261014051610280526044356102a052610180516102c0526064356102e05260c061022052610220805160208201209050816103200152602081019050806103005261030090508051602082012090506101a052610120513b1561202e576000604060a46102603760406102405261024080516020820183610320018281848460045afa50505080830192505050610160516102a0526102a0601f810180516102e0525060016102c0526102c09050805160208201836103200181518152505080830192505050806103005261030090506020815101806101c0828460045afa5050507f1626ba7e0000000000000000000000000000000000000000000000000000000061012051631626ba7e6102405260406101a051610260528061028052806102600160206101c051018082826101c060045afa50508051806020830101601f82600003163682375050601f19601f82516020010116905081015050602061024060c461025c845afa612016573d600060003e3d6000fd5b60203d106153c357610240905051186153c35761206f565b610120516000610240526101a0516101c052610160516101e05260a4356102005260c43561022052602061024060806101c060015afa5061024051186153c3575b6044356027610120516020526000526040600020806101405160205260005260406000209050556001610180510160296101205160205260005260406000205561014051610120517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9256044356101c05260206101c0a360016101c05260206101c0f35b60206120ff6101206152ae565b610120f35b60043580600f0b81186153c35760405260243580600f0b81186153c357606052602060206155d160003960005163e31593d8608052602060806004609c845afa612153573d600060003e3d6000fd5b60203d106153c3576080518060a01c6153c35760c05260c09050516383aa796a60e0526040516101005260605161012052604435610140523061016052602060e0608460fc845afa6121aa573d600060003e3d6000fd5b60203d106153c35760e09050f35b60043580600f0b81186153c35760405260243580600f0b81186153c357606052602060206155d160003960005163e31593d8608052602060806004609c845afa612207573d600060003e3d6000fd5b60203d106153c3576080518060a01c6153c35760c05260c0905051630c601c2c60e0526040516101005260605161012052604435610140523061016052602060e0608460fc845afa61225e573d600060003e3d6000fd5b60203d106153c35760e09050f35b60243580600f0b81186153c357610ae05260206004356103c052610ae0516103e052612299610b00614bd6565b610b00f35b6000546002146153c35760285460405260206040f35b6000546002146153c3576122c96103e0613370565b6103e0516103c0526122dc610500612e1e565b610500805160208160051b0180610860828560045afa50505050612301610620613177565b610620805160208160051b0180610980828560045afa50505050610240604061024061086060045afa506123366107406132b8565b610740805160208160051b01806103e0828560045afa505050506103e05160208160051b01806040826103e060045afa5050506103c0516101605261237c61052061347b565b610520516105005261050051670de0b6b3a7640000810281670de0b6b3a76400008204186153c357905060285480156153c35780820490509050610520526020610520f35b60043560040160088135116153c357803560208160051b0180836040375050506024358060011c6153c35761016052602060206155d160003960005163e31593d8610180526020610180600461019c845afa612422573d600060003e3d6000fd5b60203d106153c357610180518060a01c6153c3576101c0526101c090505163fb79eb276101e05260608061020052806102000160006040518083528060051b600082600881116153c357801561249157905b8060051b606001518160051b602088010152600101818118612474575b50508201602001915050905081019050610160516102205230610240525060206101e06101846101fc845afa6124cc573d600060003e3d6000fd5b60203d106153c3576101e09050f35b60646124e760c0613370565b60c0510460e052602060e0f35b602061250060c0613370565b60c0f35b60206125116101e0613177565b6101e060043581518110156153c35760051b60208201019050f35b6020806103005261253e6101e0613177565b6101e08161030001600082518083528060051b600082600881116153c357801561258357905b8060051b6020880101518160051b602088010152600101818118612564575b505082016020019150509050905081019050610300f35b602080610360526125ac610240612e1e565b6102408161036001600082518083528060051b600082600881116153c35780156125f157905b8060051b6020880101518160051b6020880101526001018181186125d2575b505082016020019150509050905081019050610360f35b60043580600f0b81186153c35760405260243580600f0b81186153c357606052602060206155d160003960005163e31593d8608052602060806004609c845afa612657573d600060003e3d6000fd5b60203d106153c3576080518060a01c6153c35760c05260c090505163a63530bd60e05260405161010052606051610120523061014052602060e0606460fc845afa6126a7573d600060003e3d6000fd5b60203d106153c35760e09050f35b60206155d160003960005163f851a44060c052602060c0600460dc845afa6126e2573d600060003e3d6000fd5b60203d106153c35760c0518060a01c6153c3576101005261010090505133186153c357600e546201518081018181106153c357905042106153c357426201518081018181106153c3579050602435106153c35761273f60e0613370565b60e05160c052600435606481028160648204186153c357905060e0526004351561277157620f423f6004351115612774565b60005b156153c35760c05160e051106127a45760c051600a810281600a8204186153c357905060e051116153c3576127c0565b60c05160e051600a810281600a8204186153c3579050106153c3575b60c051600c5560e051600d5542600e55602435600f557fa2b71ec6df949300b59aab36b55e189697b750119dd349fcfa8c0f779e83c25460c0516101005260e051610120524261014052602435610160526080610100a1005b60206155d160003960005163f851a44060c052602060c0600460dc845afa612846573d600060003e3d6000fd5b60203d106153c35760c0518060a01c6153c3576101005261010090505133186153c35761287360e0613370565b60e05160c05260c051600c5560c051600d5542600e5542600f557f46e22fb3709ad289f62ce63d469248536dbc78d82b84a3d7e74ad606dc20193860c05160e0524261010052604060e0a1005b60206155d160003960005163f851a440604052602060406004605c845afa6128ed573d600060003e3d6000fd5b60203d106153c3576040518060a01c6153c357608052608090505133186153c35764012a05f200600435116153c357600435600a556802b5e3af16b18800006024356004358082028115838383041417156153c35790509050116153c357602435600b557f750d10a7f37466ce785ee6bcb604aac543358db42afbcc332a3c12a49c80bf6d6040600460403760406040a1005b60206155d160003960005163f851a440604052602060406004605c845afa6129ad573d600060003e3d6000fd5b60203d106153c3576040518060a01c6153c357608052608090505133186153c35760243560043502156153c3576004356023556024356024557f68dc4e067dff1862b896b7a0faf55f97df1a60d0aaa79481b69d675f2026a28c6040600460403760406040a1005b60006000fd5b6fffffffffffffffffffffffffffffffff604051116153c3576fffffffffffffffffffffffffffffffff606051116153c35760605160801b60405117815250565b602060405160206155f16000396000518110156153c35760051b608001615591016000396000516370a0823160e0523061010052602060e0602460fc845afa612aaa573d600060003e3d6000fd5b60203d106153c35760e090505160c05260a051612bd557606051156153c357602060405160206155f16000396000518110156153c35760051b608001615591016000396000516323b872dd60e05260805161010052306101205260605161014052602060e0606460fc6000855af1612b27573d600060003e3d6000fd5b3d612b3e57803b156153c357600161016052612b56565b60203d106153c35760e0518060011c6153c357610160525b610160905051156153c357602060405160206155f16000396000518110156153c35760051b608001615591016000396000516370a0823160e0523061010052602060e0602460fc845afa612baf573d600060003e3d6000fd5b60203d106153c35760e090505160c0518082038281116153c3579050905060c052612c06565b60c0516040516001548110156153c357600201548082038281116153c3579050905060c05260605160c051106153c3575b6040516001548110156153c357600201805460c0518082018281106153c3579050905081555060c051815250565b608051156153c3576020615831600039600051612d07576040516001548110156153c35760020180546060518082038281116153c35790509050815550602060405160206155f16000396000518110156153c35760051b6080016155910160003960005163a9059cbb60a05260805160c05260605160e052602060a0604460bc6000855af1612cc8573d600060003e3d6000fd5b3d612cdf57803b156153c357600161010052612cf7565b60203d106153c35760a0518060011c6153c357610100525b610100905051156153c357612e1c565b602060405160206155f16000396000518110156153c35760051b608001615591016000396000516370a0823160c0523060e052602060c0602460dc845afa612d54573d600060003e3d6000fd5b60203d106153c35760c090505160a052602060405160206155f16000396000518110156153c35760051b6080016155910160003960005163a9059cbb60c05260805160e05260605161010052602060c0604460dc6000855af1612dbc573d600060003e3d6000fd5b3d612dd357803b156153c357600161012052612deb565b60203d106153c35760c0518060011c6153c357610120525b610120905051156153c35760a0516060518082038281116153c357905090506040516001548110156153c357600201555b565b602061585160003960005160208160051b01806158516040395050600060206155b1600039600051600881116153c357801561315c57905b8061016052600160206101605160206157116000396000518110156153c35760051b6101a0016155910160003960005118612ebb5760206101605160206159716000396000518110156153c35760051b61040001615591016000396000511515612ebe565b60005b612ffe57600360206101605160206157116000396000518110156153c35760051b6101a001615591016000396000511861315157670de0b6b3a7640000610160516040518110156153c35760051b6060015160206101605160206155f16000396000518110156153c35760051b608001615591016000396000516307a2d13a610180526020610160516020615a916000396000518110156153c35760051b61052001615591016101a0396020610180602461019c845afa612f84573d600060003e3d6000fd5b60203d106153c3576101809050518082028115838383041417156153c357905090506020610160516020615bb16000396000518110156153c35760051b61064001615591016000396000518082028115838383041417156153c3579050905004610160516040518110156153c35760051b60600152613151565b60206101605160206159716000396000518110156153c35760051b610400016155910160003960005173ffffffffffffffffffffffffffffffffffffffff811690508060a01c6153c3575a7fffffffff0000000000000000000000000000000000000000000000000000000060206101605160206159716000396000518110156153c35760051b6104000161559101600039600051166101e05260206101c0526101c05060206102206101c0516101e08585fa905090506130c4573d600060003e3d6000fd5b3d602081183d60201002186102005261020080516101805260208101516101a05250602061018051186153c3576101a0516101805160200360031b1c6101c052670de0b6b3a7640000610160516040518110156153c35760051b606001516101c0518082028115838383041417156153c3579050905004610160516040518110156153c35760051b606001525b600101818118612e56575b505060405160208160051b01808382604060045afa50505050565b6000604052600061016052600060206155b1600039600051600881116153c357801561329d57905b806101805260206158316000396000516131ee57610180516001548110156153c35760020154610180516010548110156153c357601101548082038281116153c3579050905061016052613273565b60206101805160206155f16000396000518110156153c35760051b608001615591016000396000516370a082316101a052306101c05260206101a060246101bc845afa613240573d600060003e3d6000fd5b60203d106153c3576101a0905051610180516010548110156153c357601101548082038281116153c35790509050610160525b604051600781116153c357610160518160051b60600152600181016040525060010181811861319f575b505060405160208160051b01808382604060045afa50505050565b600061028052600060206155b1600039600051600881116153c357801561335357905b806103a05261028051600781116153c357670de0b6b3a76400006103a0516040518110156153c35760051b606001516103a051610160518110156153c35760051b61018001518082028115838383041417156153c35790509050048160051b6102a001526001810161028052506001018181186132db575b50506102805160208160051b0180838261028060045afa50505050565b600f54604052600d5460605260405142106133945760605181525061347956613479565b600c54608052600e5460a0526080516060511161341657608051606051608051034260a0518082038281116153c357905090508082028115838383041417156153c3579050905060405160a0518082038281116153c3579050905080156153c357808204905090508082038281116153c3579050905081525061347956613479565b608051608051606051034260a0518082038281116153c357905090508082028115838383041417156153c3579050905060405160a0518082038281116153c3579050905080156153c357808204905090508082018281106153c357905090508152505b565b6000610180526000604051600881116153c35780156134c757905b8060051b606001516101a052610180516101a0518082018281106153c3579050905061018052600101818118613496575b5050610180516134db576000815250613702565b610180516101a0526101605160206155916000396000518082028115838383041417156153c357905090506101c052600060ff905b806101e0526101a051610200526000604051600881116153c357801561357a57905b8060051b6060015161022052610200516101a0518082028115838383041417156153c357905090506102205180156153c3578082049050905061020052600101818118613532575b505061020051602061559160003960005160206155916000396000510a80156153c35780820490509050610200526101a0516102205260646101c051610180518082028115838383041417156153c35790509050046102005160206155916000396000518082028115838383041417156153c357905090508082018281106153c357905090506101a0518082028115838383041417156153c3579050905060646101c051606481038181116153c35790506101a0518082028115838383041417156153c35790509050046001602061559160003960005101610200518082028115838383041417156153c357905090508082018281106153c3579050905080156153c357808204905090506101a052610220516101a051116136c5576001610220516101a0518082038281116153c35790509050116136f0576101a0518352505050613702566136f0565b60016101a051610220518082038281116153c35790509050116136f0576101a0518352505050613702565b60010181811861351057505060006000fd5b565b606051604051146153c3576000606051126153c35760206155b160003960005160605112156153c3576000604051126153c35760206155b160003960005160405112156153c3576101c051610200526101e0516102205260603661024037610220516102a0526102005160206155916000396000518082028115838383041417156153c357905090506102c05260006008905b806102e05260206155b16000396000516102e051186137b557613871565b6040516102e051186137cd57608051610260526137fb565b6060516102e05114613866576102e05160a0518110156153c35760051b60c00151610260526137fb56613866565b61024051610260518082018281106153c35790509050610240526102a051610220518082028115838383041417156153c357905090506102605160206155916000396000518082028115838383041417156153c3579050905080156153c357808204905090506102a0525b600101818118613797575b50506102a051610220518082028115838383041417156153c35790509050606481028160648204186153c35790506102c05160206155916000396000518082028115838383041417156153c3579050905080156153c357808204905090506102a0526102405161022051606481028160648204186153c35790506102c05180156153c357808204905090508082018281106153c357905090506102e0526102205161030052600060ff905b8061032052610300516102805261030051610300518082028115838383041417156153c357905090506102a0518082018281106153c35790509050610300518060011b818160011c186153c35790506102e0518082018281106153c35790509050610220518082038281116153c3579050905080156153c35780820490509050610300526102805161030051116139dc57600161028051610300518082038281116153c3579050905011613a0757610300518352505050613a1956613a07565b600161030051610280518082038281116153c3579050905011613a0757610300518352505050613a19565b60010181811861391c57505060006000fd5b565b600b5460a0526402540be40060a05111613a3a57608051815250613ad9565b6040516060518082018281106153c357905090506fffffffffffffffffffffffffffffffff81116153c3576002810a905060c0526402540be4006402540be40060a051038060021b818160021c186153c35790506040518082028115838383041417156153c357905090506060518082028115838383041417156153c3579050905060c05180156153c357808204905090500160805160a05102048152505b565b6fffffffffffffffffffffffffffffffff60405116815260405160801c602082015250565b602061559160003960005161016051026101a052602061559160003960005160206155916000396000510a61018051046101c052600060206155b1600039600051600881116153c3578015613ba357905b806101e0526101c051610180518082028115838383041417156153c357905090506101e0516040518110156153c35760051b6060015180156153c357808204905090506101c052600101818118613b51575b505060006101e05260646101a051604051156153c357600060051b606001518082028115838383041417156153c357905090500461030052600160078101905b806103205260206155916000396000516103205118613c0157613cbc565b6101e051600781116153c35761030051610320516040518110156153c35760051b606001516101c051604051156153c357600060051b606001518082028115838383041417156153c35790509050048082018281106153c35790509050670de0b6b3a7640000810281670de0b6b3a76400008204186153c3579050610300516101c0518082018281106153c3579050905080156153c357808204905090508160051b6102000152600181016101e05250600101818118613be3575b50506101e05160208160051b018083826101e060045afa50505050565b6040516060527ffffffffffffffffffffffffffffffffffffffffffffffffdc0d0570925a462d760405113613d12576000815250613f2c565b680755bf798b4a1bf1e46040511315613d825760106080527f7761645f657870206f766572666c6f770000000000000000000000000000000060a0526080506080518060a001601f826000031636823750506308c379a06040526020606052601f19601f6080510116604401605cfd5b6503782dace9d9604051604e1b056060526b8000000000000000000000006bb17217f7d1cf79abc9e3b39860605160601b050160601d6080526bb17217f7d1cf79abc9e3b39860805102606051036060526d02d16720577bd19bf614176fe9ea6060516c10fe68e7fd37d0007b713f7650606051010260601d0160a05279d835ebba824c98fb31b83b2ca45c0000000000000000000000006060516e0587f503bb6ea29d25fcb74019645060a0516d04a4fd9f2a8b96949216d2255a6c60605160a05101030260601d01020160c0526d0277594991cfc85f6e2461837cd96060516c240c330e9fb2d9cbaf0fd5aafc606051030260601d0160e0526d1a521255e34f6a5061b25ef1c9c460605160e0510260601d0360e0526db1bbb201f443cf962f1a1d3db4a560605160e0510260601d0160e0526e02c72388d9f74f51a9331fed693f1560605160e0510260601d0360e0526e05180bb14799ab47a8a8cb2a527d5760605160e0510260601d0160e05260e05160c051056101005274029d9dc38563c32e5c2f6dc192ee70ef65f9978af3610100510260805160c303600081126153c3571c8152505b565b6fffffffffffffffffffffffffffffffff6101205116610180526101205160801c6101a0524261016051101561402f5761014051670de0b6b3a764000061016051420302048060ff1c6153c3577f800000000000000000000000000000000000000000000000000000000000000081146153c357600003604052613fb36101e0613cd9565b6101e0516101c052670de0b6b3a7640000610180516101c05180670de0b6b3a764000003670de0b6b3a764000081116153c35790508082028115838383041417156153c357905090506101a0516101c0518082028115838383041417156153c357905090508082018281106153c3579050905004815250614037565b6101a0518152505b565b60255460405261404a6104e0613adb565b6104e060406104a060408360045afa505060195460208160051b01600081601f0160051c600981116153c357801561409757905b80601901548160051b6104e0015260010181811861407e575b505050506104e05160208160051b0180610600826104e060045afa5050506103405160208160051b018060408261034060045afa505050610460516101605261048051610180526140e9610840613b00565b610840805160208160051b0180610720828560045afa5050505060006008905b80610840526020615591600039600051600181038181116153c3579050610840511861413457614203565b61084051610720518110156153c35760051b6107400151156141f85761084051610720518110156153c35760051b6107400151671bc16d674ec80000818118671bc16d674ec800008310021890506108a052610840516104e0518110156153c35760051b610500015161012052602354610140526104a051610160526141bb610860613f2e565b610860516108c0526040604060406108a060045afa506141dc610880612a1b565b6108805161084051610600518110156153c35760051b61062001525b600101818118614109575b50506106005160208160051b01600081601f0160051c600981116153c357801561424257905b8060051b61060001518160190155600101818118614229575b5050505060225461084052610480516108a0526108405161012052602454610140526104c05161016052614277610860613f2e565b610860516108c0526040604060406108a060045afa50614298610880612a1b565b6108805160225560006002905b80610860524261086051600181116153c35760051b6104a0015110156142db574261086051600181116153c35760051b6104a001525b6001018181186142a55750506104a0516040526104c051606052614300610860612a1b565b61086051602555565b614314610c20613370565b610c2051610c00526109805160208160051b018060408261098060045afa505050610c005161016052614348610c4061347b565b610c4051610c2052610bc051604052610be051606052610960516080526109805160208160051b018060a08261098060045afa505050610c00516101c052610c20516101e052614399610c60613704565b610c6051610c4052610be051610980518110156153c35760051b6109a00151610c40518082038281116153c35790509050600181038181116153c3579050610c60526402540be400610c6051610bc051610980518110156153c35760051b6109a00151610960518082018281106153c3579050905060011c604052610be051610980518110156153c35760051b6109a00151610c40518082018281106153c3579050905060011c606052600a54608052614454610ca0613a1b565b610ca0518082028115838383041417156153c3579050905004610c8052610c6051610c80518082038281116153c35790509050670de0b6b3a7640000810281670de0b6b3a76400008204186153c3579050610be051610aa0518110156153c35760051b610ac0015180156153c35780820490509050610c6052610be0516010548110156153c3576011018054610be051610aa0518110156153c35760051b610ac001516402540be400610c805164012a05f20081028164012a05f2008204186153c357905004670de0b6b3a7640000810281670de0b6b3a76400008204186153c3579050048082018281106153c357905090508155506109805160208160051b0180610ca08261098060045afa50505061096051610bc051610ca0518110156153c35760051b610cc00152610c4051610be051610ca0518110156153c35760051b610cc00152610ca05160208160051b018061034082610ca060045afa505050610c005161046052610c2051610480526145cc614039565b610c6051815250565b610e0051610de051146153c357610e2051156153c3576145f6610fc0612e1e565b610fc0805160208160051b0180610ea0828560045afa5050505061461b6110e0613177565b6110e0805160208160051b0180610fc0828560045afa50505050610ea05160208160051b0180604082610ea060045afa505050610fc05160208160051b018061016082610fc060045afa5050506146736112006132b8565b611200805160208160051b01806110e0828560045afa50505050610de051604052610e2051606052610dc051608052610e805160a0526146b4611220612a5c565b6112205161120052610de0516110e0518110156153c35760051b6111000151670de0b6b3a764000061120051610de051610ea0518110156153c35760051b610ec001518082028115838383041417156153c35790509050048082018281106153c357905090506112205261122051610960526110e05160208160051b0180610980826110e060045afa505050610ea05160208160051b0180610aa082610ea060045afa505050610de051610bc052610e0051610be052614775611260614309565b6112605161124052610e405161124051101561481657602e611260527f45786368616e676520726573756c74656420696e20666577657220636f696e73611280527f207468616e2065787065637465640000000000000000000000000000000000006112a05261126050611260518061128001601f826000031636823750506308c379a061122052602061124052601f19601f61126051011660440161123cfd5b610e005160405261124051606052610e6051608052614833612c34565b337f8b3e96f2b889fa771c53c981b40daf005f63f637f1869f707052d15a3dd97140610de051611260526112005161128052610e00516112a052611240516112c0526080611260a261124051815250565b6103c05160208160051b01806040826103c060045afa5050506104e05160208160051b0180610160826104e060045afa5050506148c26107406132b8565b610740805160208160051b0180610620828560045afa505050506106205160208160051b018060408261062060045afa505050610600516101605261490861074061347b565b61074051815250565b6000606051126153c35760206155b160003960005160605112156153c3576060366101c0376101a0516102205260405160206155916000396000518082028115838383041417156153c357905090506102405260006008905b806102605260206155b1600039600051610260511861498857614a2c565b6060516102605114614a2157610260516080518110156153c35760051b60a001516101e0526149b656614a21565b6101c0516101e0518082018281106153c357905090506101c052610220516101a0518082028115838383041417156153c357905090506101e05160206155916000396000518082028115838383041417156153c3579050905080156153c35780820490509050610220525b60010181811861496a575b5050610220516101a0518082028115838383041417156153c35790509050606481028160648204186153c35790506102405160206155916000396000518082028115838383041417156153c3579050905080156153c35780820490509050610220526101c0516101a051606481028160648204186153c35790506102405180156153c357808204905090508082018281106153c35790509050610260526101a05161028052600060ff905b806102a052610280516102005261028051610280518082028115838383041417156153c35790509050610220518082018281106153c35790509050610280518060011b818160011c186153c3579050610260518082018281106153c357905090506101a0518082038281116153c3579050905080156153c3578082049050905061028052610200516102805111614b9757600161020051610280518082038281116153c3579050905011614bc257610280518352505050614bd456614bc2565b600161028051610200518082038281116153c3579050905011614bc257610280518352505050614bd4565b600101818118614ad757505060006000fd5b565b614be1610420613370565b6104205161040052614bf4610540612e1e565b610540805160208160051b0180610420828560045afa505050506104205160208160051b01806108a08261042060045afa505050614c33610660613177565b610660805160208160051b01806109c0828560045afa5050505061024060406102406108a060045afa50614c686107806132b8565b610780805160208160051b0180610540828560045afa505050506105405160208160051b018060408261054060045afa5050506104005161016052614cae61068061347b565b610680516106605260285461068052610660516103c051610660518082028115838383041417156153c357905090506106805180156153c357808204905090508082038281116153c357905090506106a052610400516040526103e0516060526105405160208160051b018060808261054060045afa5050506106a0516101a052614d3a6106e0614911565b6106e0516106c052600160206155916000396000510360021b6020615591600039600051600a5402046106e0526105405160208160051b01806107008261054060045afa505050602061559160003960005160011b610660516106a0518082018281106153c3579050905004610820526080366108403760006008905b806108c05260206155b16000396000516108c05118614dd557614f33565b6000610840526108c051610540518110156153c35760051b6105600151610860526103e0516108c05118614e6857610860516106a0518082028115838383041417156153c357905090506106605180156153c357808204905090506106c0518082038281116153c3579050905061084052610860516106c0518082018281106153c3579050905060011c61088052614eb4565b61086051610860516106a0518082028115838383041417156153c357905090506106605180156153c357808204905090508082038281116153c357905090506108405261086051610880525b61088051604052610820516060526106e051608052614ed46108e0613a1b565b6108e0516108a052610860516402540be4006108a051610840518082028115838383041417156153c35790509050048082038281116153c357905090506108c051610700518110156153c35760051b6107200152600101818118614db7575b50506103e051610700518110156153c35760051b6107200151610400516040526103e0516060526107005160208160051b018060808261070060045afa5050506106a0516101a052614f866108e0614911565b6108e0518082038281116153c357905090506108c0526103e051610540518110156153c35760051b61056001516106c0518082038281116153c35790509050670de0b6b3a7640000810281670de0b6b3a76400008204186153c35790506103e051610420518110156153c35760051b610440015180156153c357808204905090506108e0526103e051610420518110156153c35760051b61044001516108c051600181038181116153c3579050670de0b6b3a7640000810281670de0b6b3a76400008204186153c3579050046108c0526106c0516103e051610540518110156153c35760051b61056001526108c05181526108e0516108c0518082038281116153c3579050905060208201526105405160208160051b016040830181818361054060045afa50505050610400516101608201526106a05161018082015250565b6028546060518082038281116153c357905090506028556026604051602052600052604060002080546060518082038281116153c3579050905081555060006040517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60605160805260206080a3565b60206155d160003960005163cab4d3db610160526020610160600461017c845afa615166573d600060003e3d6000fd5b60203d106153c357610160518060a01c6153c3576101a0526101a09050516101405261014051615195576152ac565b60105460208160051b01600081601f0160051c600981116153c35780156151d157905b80601001548160051b61016001526001018181186151b8575b50505050600060206155b1600039600051600881116153c357801561526857905b806102805261028051610160518110156153c35760051b61018001511561525d576102805160405261028051610160518110156153c35760051b610180015160605261014051608052615243612c34565b600061028051610160518110156153c35760051b61018001525b6001018181186151f2575b50506101605160208160051b01600081601f0160051c600981116153c35780156152a757905b8060051b6101600151816010015560010181811861528e575b505050505b565b6020615d916000396000514614615338577fd87cd6ef79d4e2b95e15ce8abf732db51ec771f1ca2edccf22a46c729ac564726060526020615d716080397f1c54f243822e0e9a0a377610b81577e771b3efe79964e76636b0d5d10247950d60a0524660c0523060e0526020615db16101003960c06040526040805160208201209050815250615341565b6020615dd18239505b565b6026604051602052600052604060002080546080518082038281116153c357905090508155506026606051602052600052604060002080546080518082018281106153c357905090508155506060516040517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60805160a052602060a0a3565b600080fd0299552109065754410a809453e60d1cfc54870c0081556007076c54db0ad40ddb8c15a5652081066c00e1059c4258c4011f053931ab521a342554fd4d5001d40576a9cd3e2608455e604cd215b585b72df5de0411651a4d01d20c376567df02ca21046529357750006a05e2e7d26400f925ec0238621a7d25fd0684b1259a0518160ddd229e05a9059cbb1c194570a0823102432530c540851a1605ddca3f4300a2055e0d443f21b86506fdde03013705a7256d09041b85c66106570078258edfdd5f00ae05ddc1f59d02f2a5cc2b27d7226c4590d208371a60253644e51520f205313ce56701c905081579a50c41851ddc3b01012b05d505accf1db8e5bfa0b13302da0595d89b410180051be913a50113057706db750e5565fee3f7f900ba05095ea7b31d4c4514f05979252c0565bbea6b298045907a016b1be505b4b577ad00d5054903b0d125042523b872dd1c4a65687276531b94252969e04a15cfa5551a65882819051405228800ed055409491a00c905015c283828c0454a6e32c60e5f857ecebe0002b2257e3db030037585dd62ed3e026b45bb7b8b8022b4053c157e6426b54576a2f0f024f4053df0212402e885f446c1d024db053db06dd823c165afb43012037fa500000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000d2002373543ce3527023c75e7518c274a51ce7120000000000000000000000000000000000000000000000000000000000000002000000000000000000000000b102f7efa0d5de071a8d37b3548e1c7cb148caf3000000000000000000000000fc00000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d6372765553442f667278555344000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a6372765553444652415800000000000000000000000000000000000000000000edc2251b0bef79ff494ba35ae6c61b8845a57744dfbdaac2700a800f50ab5c8800000000000000000000000000000000000000000000000000000000000000fcbfa76e783a7543bf77dba3ba9476e9793835bebd00075f8db2fba0f73d82160dfcabf13b14381eb2184cc21211bb3b16c2fba681add3f8e1958e88ca06581fde");

        let change = ByteCodeChange{
            address: address!("63Eb7846642630456707C3efBb50A03c79B89D81"),
            offset:  23761,
            value:   bytes!("0x000000000000000000000000000000000000000000000000000000000000000d6372765553442f66727855534400000000000000000000000000000000000000"),
        };

        code[change.offset..change.offset + change.value.len()].copy_from_slice(&change.value);

        println!("new hex: {}", code.encode_hex());
    }
}
